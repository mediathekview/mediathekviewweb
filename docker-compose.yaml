services:
  app:
    build: .
    ports:
      - "${WEBSERVER_PORT:-8000}:${WEBSERVER_PORT:-8000}"
    depends_on:
      - opensearch
      - valkey
    env_file:
      - .env
    volumes:
      - "./data:/usr/src/app/data"
    restart: unless-stopped
    healthcheck:      
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/stats"]
      interval: 30s
      timeout: 10s
      retries: 3

  opensearch:
    image: opensearchproject/opensearch:3
    environment:
      discovery.type: single-node
      bootstrap.memory_lock: "true"
      OPENSEARCH_JAVA_OPTS: -Xms512m -Xmx512m
      DISABLE_INSTALL_DEMO_CONFIG: "true"
      DISABLE_SECURITY_PLUGIN: "true"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: MediathekViewWeb01!
    volumes:
      - "opensearch:/usr/share/opensearch/data"
    restart: unless-stopped

  valkey:
    image: valkey/valkey:8-alpine
    command: ["--save", "60", "1"]
    volumes:
      - "valkey:/data"
    restart: unless-stopped

volumes:
  valkey:
  opensearch: